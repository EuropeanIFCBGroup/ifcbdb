{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<link href="{% static 'vendor/leaflet-areaselect/leaflet-areaselect.css' %}" rel="stylesheet" />
<link href="{% static 'vendor/leaflet-markercluster/MarkerCluster.css' %}" rel="stylesheet" />
<link href="{% static 'vendor/leaflet-markercluster/MarkerCluster.Default.css' %}" rel="stylesheet" />
{% endblock %}
{% block content %}

<div class="row">
    <div class="col">
        <span class="h3-responsive">Locate a Dataset</span>
        <div id="progress"><div id="progress-bar"></div></div>
    </div>
</div>
<hr class="my-2">
<div class="row py-2 px-3">
    <div class="col-xs-12 col-lg-8">
        <div class="card h-100">
            <div class="card-body text-primary">
                <div class="row">
                    <div class="col-xs-12 col-md-4 col-lg-6 col-xl-4 order-2 order-md-1 pt-2 pt-md-0">
                        <form method="post" class="form black-text" id="search-form">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="id_start_date">Start Date:</label>
                                {{ form.start_date }}
                            </div>
                            <div class="form-group">
                                <label for="id_end_date">End Date:</label>
                                {{ form.end_date }}
                            </div>

                            <div class="form-group">
                                <label for="id_min_depth">Min Depth:</label>
                                {{ form.min_depth }}
                            </div>
                            <div class="form-group">
                                <label for="id_max_depth">Max Depth:</label>
                                {{ form.max_depth }}
                            </div>
                            <div class="form-group">
                                <label>Region:</label><br />
                                <a href="javascript:;" id="select-region" class="btn btn-sm btn-mdb-color">Select a Region</a>
                                <div id="region" class="d-none card p-2">
                                    <div class="row">
                                        <div class="col-md-5">Southwest:</div>
                                        <div class="col-md-3 p-0 mr-1">{{ form.region_sw_lat }}</div>
                                        <div class="col-md-3 p-0">{{ form.region_sw_lon }}</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-5">Northeast:</div>
                                        <div class="col-md-3 p-0 mr-1">{{ form.region_ne_lat }}</div>
                                        <div class="col-md-3 p-0">{{ form.region_ne_lon }}</div>
                                    </div>
                                    <a href="javascript:;" id="cancel-region" class="btn btn-sm btn-mdb-color">Cancel</a>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-mdb-color btn-block">Search</button>
                        </form>
                    </div>
                    <div class="col-xs-12 col-md-8 col-lg-6 col-xl-8 order-1 order-md-2">
                        <div id="map-container" style="height:500px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xs-12 col-lg-4 pt-3 pt-lg-0">
        <div class="card h600 h-100">
            <div class="card-header mdb-color lighten-5">
                <span class="h5-responsive">Datasets:</span>
            </div>
            <div class="card-body overflow-auto">
                <div>
                    <ul class="list-group list-group-flush" id="dataset-list">
                        {% for dataset in datasets %}
                        <li class="list-group-item">
                            <a href="{% url 'timeline_page' %}?dataset={{ dataset.name }}">{{ dataset.title }}</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="debug"></div>
</div>
{% endblock %} {% block scripts %}
<script type="text/javascript" src="{% static 'vendor/leaflet-areaselect/leaflet-areaselect.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/leaflet-markercluster/leaflet.markercluster.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/leaflet-markercluster/realworld.50000.1.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/leaflet-markercluster/realworld.50000.2.js' %}"></script>
<script>
    var map;
    var areaSelect;

		var progress = document.getElementById('progress');
		var progressBar = document.getElementById('progress-bar');

    function enableRegionSelection() {
        areaSelect = L.areaSelect({width:200, height:250});
        areaSelect.on("change", function() {
            var bounds = this.getBounds();
            $("#id_region_sw_lat").val(bounds.getSouthWest().lat);
            $("#id_region_sw_lon").val(bounds.getSouthWest().lng);
            $("#id_region_ne_lat").val(bounds.getNorthEast().lat);
            $("#id_region_ne_lon").val(bounds.getNorthEast().lng);
        });
        areaSelect.addTo(map);

        $("#select-region").toggleClass("d-none", true);
        $("#region").toggleClass("d-none", false);
    }

    function cancelRegionSelection() {
        areaSelect.remove();
        $("#id_region_sw_lat").val("");
        $("#id_region_sw_lon").val("");
        $("#id_region_ne_lat").val("");
        $("#id_region_ne_lon").val("");
        $("#select-region").toggleClass("d-none", false);
        $("#region").toggleClass("d-none", true);
    }

    		function updateProgressBar(processed, total, elapsed, layersArray) {
    		console.log("xxx");
			if (elapsed > 1000) {
				// if it takes more than a second to load, display the progress bar:
				progress.style.display = 'block';
				progressBar.style.width = Math.round(processed/total*100) + '%';
			}

			if (processed === total) {
				// all markers processed - hide the progress bar:
				progress.style.display = 'none';
			}
		}

    $(function() {
        map = createMap();

        var markers = L.markerClusterGroup({ chunkedLoading: true, chunkProgress: updateProgressBar });
		var markerList = [];

        $("#select-region").click(function(e){
            enableRegionSelection();
        });

        $("#cancel-region").click(function(){
            cancelRegionSelection();
        });

        $("#search-form").submit(function(e){
            e.preventDefault();

            var formData = $(this).serialize();
            $.post("/api/search_datasets", formData, function(data){
                console.log(data);
                $("#dataset-list").empty();
                for (var i = 0; i < data.datasets.length; i++) {
                    var dataset = data.datasets[i];
                    var li = $("<li class='list-group-item' />");
                    var link = $("<a href='{% url 'timeline_page' %}?dataset=" + dataset["name"] + "'>" + dataset["title"] + "</a>");

                    li.append(link);
                    $("#dataset-list").append(li);
                }

                // TODO: Second call to get locations, so the UI is not waiting on this to return
                formData += "&include_locations=true";

                $.post("/api/search_datasets", formData, function(locationData){
                    for (var i = 0; i < locationData.locations.length; i++) {
                        var a = locationData.locations[i];
                        var title = a[0];
                        var marker = L.marker(L.latLng(a[1], a[2]), { title: title });
                        marker.bindPopup(title);
                        markerList.push(marker);
                    }

                    console.log('start clustering: ' + window.performance.now());

                    markers.addLayers(markerList);
                    map.addLayer(markers);

                    console.log('end clustering: ' + window.performance.now());

                });
            });
        });
    });
</script>
{% endblock %}