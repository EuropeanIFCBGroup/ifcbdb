{% extends 'base.html' %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a class="black-text" href="{% url 'dataset' dataset.name %}?bin_id={{ bin.pid }}">{{ dataset.name }}</a></li>
<li class="breadcrumb-item"><a class="black-text" href="{% url 'bin' dataset.name bin.pid %}">{{ bin.pid }}</a></li>
<li class="breadcrumb-item"><a class="black-text" href="{% url 'image' dataset.name bin.pid image_id %}">{{ image_id }}</a></li>
{% endblock %}

{% block content %}
<div class="row d-flex justify-content-between">
    <div class="col">
        <span class="h3-responsive">{{ bin.pid }}_{{ image_id|stringformat:"05d" }}</span>
    </div>
    <div class="pl-3 align-self-center">
        <a title="Share link"><span id="share-button" class="h5-responsive fa fa-share-square"></span></a>
    </div>
</div>
<hr class="my-2">
<div class="row py-2 px-3">
    <div class="col">
        <div class="card h-100">
            <div class="card-header py-1 mdb-color lighten-5">
                <div class="row d-flex justify-content-between">
                    <div class="col">
                        <span class="h5-responsive">Image</span>
                    </div>
                    <ul class="nav justify-content-end" id="ImageTabs" role="tablist">
                        <li class="nav-item">
                            <a class="btn btn-sm btn-mdb-color" id="image-tab-label" data-toggle="tab" href="#image-tab" role="tab" aria-controls="image-tab" aria-selected="true">Image</a>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-sm btn-mdb-color {% if not details.has_blobs %}disabled{% endif %}" id="blob-tab-label" data-toggle="tab" href="#blob-tab" role="tab" aria-controls="blob-tab" aria-selected="false">Blob</a>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-sm btn-mdb-color {% if not details.has_blobs %}disabled{% endif %}" id="outline-tab-label" data-toggle="tab" href="#outline-tab" role="tab" aria-controls="outline-tab" aria-selected="false">Outline</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-body text-center">
                <div class="row h-100 justify-content-center align-items-center">
                    <div class="col">
                <div class="tab-content" id="ImageTabContent">
                    <div class="tab-pane show active" id="image-tab" role="tabpanel" aria-labelledby="image-tab-label">
                        <img id="image" class="img-fluid" src="data:image/png;base64,{{ image }}" />
                    </div>
                    <div class="tab-pane" id="blob-tab" role="tabpanel" aria-labelledby="blob-tab-label">
                        <img id="image-blob" class="img-fluid">
                    </div>
                    <div class="tab-pane" id="outline-tab" role="tabpanel" aria-labelledby="outline-tab-label">
                        <img id="image-outline" class="img-fluid">
                    </div>
                </div>
                <div id="scale-bar">
                  <div class="scale-bar"></div>
                  <div>10Î¼m</div>
                </div>
            </div>
            </div>
            </div>
        </div>
    </div>
</div>
<div class="row py-2 px-3">
    <div class="col-md-6 col-xl-8">
        <div class="card vh-50 h-100">
            <div class="card-header py-1 mdb-color lighten-5">
                <span class="h5-responsive">Metadata</span>
            </div>
            <div class="card-body overflow-auto">
                <div class="table-responsive text-nowrap">
                    <table class="table table-striped table-sm table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Field</th>
                                <th scope="col">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for key, value in metadata.items %}
                            <tr>
                                <th scope="row">{{ key }}</th>
                                <td>{{ value|floatformat:-4 }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-4 mt-2 mt-md-0">
        <div class="card h-100">
            <div class="card-body">
                <div id="mapid" class="h-100 min-vh-25"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-2 mt-2 mt-xl-0 d-none">
        <div class="card vh-50 h-100">
            <div class="card-header py-1 mdb-color lighten-5">
                <div class="row">
                    <div class="col">
                        <span class="h5-responsive">Annotations</span>
                    </div>
                </div>
            </div>
            <div class="card-body overflow-auto">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 1</a>
                    </li>
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 2</a>
                    </li>
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 3</a>
                    </li>
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 3</a>
                    </li>
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 3</a>
                    </li>
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 3</a>
                    </li>
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 3</a>
                    </li>
                    <li class="list-group-item">
                        <a data-toggle="modal" data-target="#AnnotationExampleModal"><i class="far fa-sticky-note mr-1" aria-hidden="true"></i>Annotation 3</a>
                    </li>
                </ul>
            </div>
            {% if user.is_authenticated %}
            <div class="card-footer py-1 text-right white">
                <a data-toggle="modal" data-target="#addAnnotationModal" class="btn btn-unique btn-sm"><i class="fas fa-plus-circle" aria-hidden="true"></i>Add</a>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6 col-xl-2 mt-2 mt-xl-0 d-none">
        <div class="card vh-50 h-100">
            <div class="card-header py-1 mdb-color lighten-5">
                <div class="row">
                    <div class="col">
                        <span class="h5-responsive">Tags</span>
                    </div>
                </div>
            </div>
            <div class="card-body overflow-auto">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="#" class="badge badge-pill badge-primary badge-block"><i class="fas fa-tag fa-2x mr-1" aria-hidden="true"></i>Tag 1</a>
                    </li>
                    <li class="list-group-item">
                        <a href="#" class="badge badge-pill badge-primary"><i class="fas fa-tag fa-2x mr-1" aria-hidden="true"></i>Tag 2</a>
                    </li>
                    <li class="list-group-item">
                        <a href="#" class="badge badge-pill badge-primary"><i class="fas fa-tag fa-2x mr-1" aria-hidden="true"></i>Tag 3</a>
                    </li>
                </ul>

            </div>
            {% if user.is_authenticated %}
            <div class="card-footer py-1 text-right white">
                <a data-toggle="modal" data-target="#addTagModal" class="btn btn-unique btn-sm"><i class="fas fa-plus-circle" aria-hidden="true"></i>Add</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="AnnotationExampleModal" tabindex="-1" role="dialog" aria-labelledby="AnnotationExampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="AnnotationExampleModalLabel">Annotation Title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
            </div>
            <div class="modal-body">
                Annotation Body text would go here.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<!-- Modal -->
<div class="modal fade" id="addAnnotationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 font-weight-bold">Add Annotation</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
            </div>
            <div class="modal-body mx-3">
                <div class="md-form mb-5">
                    <i class="fas fa-pencil-alt prefix"></i>
                    <textarea id="form10" class="md-textarea form-control" rows="3"></textarea>
                    <label for="form10">Annotation Text</label>
                </div>

                <div class="md-form mb-4">
                    <i class="fas fa-lock prefix grey-text"></i>
                    <input type="text" id="defaultForm-pass" class="form-control validate">
                    <label data-error="wrong" data-success="right" for="defaultForm-pass">Your Name</label>
                </div>

            </div>
            <div class="modal-footer d-flex justify-content-right">
                <button class="btn btn-default">Add</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<!-- Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h4 class="modal-title w-100 font-weight-bold">Add Tag</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body mx-3">
                <div class="md-form mb-5">
                    <i class="fas fa-tag prefix grey-text"></i>
                    <input type="text" id="defaultForm-email" class="form-control validate">
                    <label data-error="wrong" data-success="right" for="defaultForm-email">Tag</label>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-right">
                <button class="btn btn-default">Add</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="share-modal" tabindex="-1" role="dialog" aria-labelledby="share-modal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Share link</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
            </div>
            <div class="modal-body">
                <input id="share-link" size="50" value="{{ request.scheme }}://{{ request.get_host }}{% url 'image_legacy' dataset.name bin.pid image_id %}">
            </div>
            <div class="modal-footer">
                <button id="copy-share-link" type="button" class="btn btn-mdb-color btn-sm">Copy to clipboard</button>
                <!--button type="button" class="btn btn-mdb-color btn-sm" data-dismiss="modal">Close</button-->
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
{% endblock %}

{% block scripts %}
<script>
    $("#blob-tab-label").click(function(e){
        e.preventDefault();

        if ($('#image-blob').attr("src") == undefined) {
            $.get("{% url 'image_blob' bin.pid image_id %}", function(data){
                if (data["blob"] != "")
                    $("#image-blob").attr("src", "data:image/png;base64," + data["blob"]);
            });
        }
    });

    $("#outline-tab-label").click(function(e){
        e.preventDefault();

        if ($("#image-outline").attr("src") == undefined) {
            $.get("{% url 'image_outline' bin.pid image_id %}", function(data){
                if (data["outline"] != "")
                    $("#image-outline").attr("src", "data:image/png;base64," + data["outline"]);
            });
        }
    });

    $(function(){
        var map = createMap({{ details.lat }}, {{ details.lng }});
        addMapMarker(map, {{ details.lat }}, {{ details.lng }}, {{ bin.depth }});

        // Default the width/height of the blob/outline images to prevent flicker when resizing
        $("#image-blob").width($("#image").width());
        $("#image-blob").height($("#image").height());
        $("#image-outline").width($("#image").width());
        $("#image-outline").height($("#image").height());
    });

    $("#share-button").click(function () {
        $("#share-modal").modal();
        $("#share-link").select();
    });

    $("#copy-share-link").click(function() {
        $("#share-link").select();
        document.execCommand("Copy");
    });

    function handleScaleBar() {
        var currentImageWidth = $("#image").width();
        if(currentImageWidth != {{ image_width }}) {
            $("#scale-bar").hide();
        } else {
            $("#scale-bar").show();
        }        
    }
    $(window).resize(function() {
        handleScaleBar();
    });

    handleScaleBar();

</script>
{% endblock %}