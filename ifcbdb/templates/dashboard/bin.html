{% extends 'base.html' %}
{% load static %}

{% block breadcrumbs %}
    <!-- TODO: datasets is hard coded into the base file and should not be seen for a bin only view; also remove ** indicator -->
    {% if dataset %}
        **
        <li class="breadcrumb-item"><a class="black-text" href="{% url 'dataset_combined' dataset.name %}">{{ dataset.name }}</a></li>
        <li class="breadcrumb-item"><a class="black-text" href="{% url 'dataset_combined' dataset.name %}?bin_id={{ bin.pid }}">{{ bin.pid }}</a></li>
    {% else %}
        <li class="breadcrumb-item"><a class="black-text" href="{% url 'bin_combined' bin.pid %}">{{ bin.pid }}</a></li>
    {% endif %}
{% endblock %}

{% block content %}

{% if dataset %}
    <div class="row d-flex justify-content-between">
        <!-- Dataset header row -->
        <div class="pl-3">
            <span class="h3-responsive">{{ dataset.title }}</span>
            <span>
                <button class="btn btn-link" data-toggle="collapse" data-target=".ts-collapse" aria-expanded="true" aria-controls="ts-data">
                    <i class="fa" aria-hidden="true"></i>
                </button>
            </span>
        </div>

        {% if user.is_authenticated %}
        <div>
            <a href="#" class="btn btn-sm btn-primary ml-3">Configure</a>
        </div>
        {% endif %}

        <!-- Nav options for the timeline control -->
        <ul class="nav justify-content-end collapse show ts-collapse" id="ts-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-size-tab" data-toggle="tab" data-metric="size" href="#ts-size"
                   role="tab" data-target="ts-size" aria-selected="false">Data Size</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-temperature-tab" data-toggle="tab" data-metric="temperature" href="#ts-temperature"
                   role="tab" data-target="ts-temperature" aria-selected="false">Temperature</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-humidity-tab" data-toggle="tab" data-metric="humidity" href="#ts-humidity"
                   role="tab" data-target="ts-humidity" aria-selected="false">Humidity</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-ml-analyzed-tab" data-toggle="tab" data-metric="ml-analyzed" href="#ts-ml-analyzed"
                   role="tab" data-target="ts-ml-analyzed" aria-selected="false">Volume Analyzed</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm active" id="ts-concentration-tab" data-toggle="tab" data-metric="concentration" href="#ts-concentration"
                   role="tab" data-target="ts-concentration" aria-selected="true">ROIs / ml</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-triggers-tab" data-toggle="tab" data-metric="n-triggers" href="#ts-triggers"
                   role="tab" data-target="ts-triggers" aria-selected="false">Trigger Count</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-images-tab" data-toggle="tab" data-metric="n-images" href="#ts-images"
                   role="tab" data-target="ts-images" aria-selected="false">Image Count</a>
            </li>
        </ul>
    </div>

    <hr class="my-2">

    <!-- Timeline control -->
    <div class="row px-1">
        <div class="col-sm-12">
            <div class="tab-content collapse show ts-collapse" id="ts-data">
                <div id="primary-plot-container" class="ts-plot-container"></div>
            </div>
        </div>
    </div>
{% else %}
    <!-- Bin only header -->
    <div class="row d-flex justify-content-between">
        <div class="pl-3">
            <span class="h3-responsive">{{ bin.pid }}</span>
        </div>
    </div>
{% endif %}

<div class="row py-2">
    <div class="col-sm-12">
        <div class="card">

            <!-- Card Header -->
            <div class="card-header py-1 px-0 white">
                <div class="d-flex flex-row justify-content-between">

                    <!-- Bin selection links/label -->
                    <div class="col-sm-9">
                        <div class="d-flex flex-row justify-content-between">
                            <a href="#" id="previous-bin" data-bin="" class="btn btn-mdb-color btn-sm btn-previous w-25">Previous Bin</a>
                            <div class="flex-column text-center w-50">
                                <span class="p">
                                    <strong>Selected Bin:</strong>
                                    <a id="bin-header" href="{% url 'bin_combined' bin.pid %}">{{ bin.pid }}</a>
                                </span>
                            </div>
                            <a href="#" id="next-bin" data-bin="" class="btn btn-mdb-color btn-sm btn-next w-25">Next Bin</a>
                        </div>
                    </div>

                    <!-- Bin view (mosaic/plot/map -->
                    <div class="col-sm-3">
                        <ul class="nav justify-content-end" id="myTab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link btn btn-mdb-color btn-sm  btn-block active" id="show-mosaic"
                                   data-toggle="tab" href="#" role="tab">Mosaic</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link btn btn-mdb-color btn-sm btn-block" id="show-plot"
                                   data-toggle="tab" href="#" role="tab">Plot</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link btn btn-mdb-color btn-sm btn-block" id="show-map"
                                   data-toggle="tab" href="#" role="tab">Map</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Card body -->
            <div class="card-body">
                <!-- Top half -->
                <div class="row">
                    <!-- Left side of outer card area )plot/map/mosaic -->
                    <div class="col-xl-9">
                        <div class="card h-100 min-vh-50">

                            <!-- Plot -->
                            <div id="plot-tab" class="card-body tab-pane py-1 d-none" role="tabpanel">
<div class="row py-2 px-3">
    <div class="col-md-7 text-center">
                    <form class="form form-row">
                        <div class="form-group mr-2">
                            <label>X Axis</label>
                            <select id="plot-x-axis" class="form-control" style="width:150px"></select>
                        </div>
                        <div class="form-group mr-2">
                            <label>Y Axis</label>
                            <select id="plot-y-axis" class="form-control" style="width:150px"></select>
                        </div>
                        <div class="form-group mr-2">
                            <label>X Type</label>
                            <select id="plot-x-type" class="form-control">
                                <option value="">Linear</option>
                                <option value="log">Log</option>
                            </select>
                        </div>
                        <div class="form-group mr-2">
                            <label>Y Type</label>
                            <select id="plot-y-type" class="form-control">
                                <option value="">Linear</option>
                                <option value="log">Log</option>
                            </select>
                        </div>
                        <div class="form-group mr-2">
                            <label>X Offset</label>
                            <input type="text" id="plot-x-offset" class="form-control" disabled style="width:100px" />
                        </div>
                        <div class="form-group">
                            <label>Y Offset</label>
                            <input type="text" id="plot-y-offset" class="form-control" disabled style="width:100px" />
                        </div>
                    </form>

                    <div id="plot" class="bin-plot"></div>


    </div>
    <div class="col-md-5">
        <div class="card h-100 z-depth-0 border" id="plotImages">
            <div class="card-body text-center overflow-auto" id="plot-images-container">
                <div>
                    <div class="alert alert-danger" id="too-many-images" style="display:none">
                        Too many images have been selected. Only the first <strong id="max-images"></strong> are shown
                    </div>
                    <div id="plot-images"></div>
                </div>
            </div>
        </div>
    </div>
</div>
            </div>

                            <!-- Map -->
                            <div id="map-tab" class="card-body tab-pane py-1 d-none" role="tabpanel">
                                <div id="mapid" class="h-100"></div>
                                <div id="map-loading" class="text-center">
                                    <div class="spinner-border spinner-center" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Mosaic -->
                            <div id="image-tab" class="card-body text-center py-1" role="tabpanel">
                                <div class="overflow-auto">
                                    <img id="mosaic" src="" style="display:none" />
                                </div>
                                <div id="mosaic-loading" class="grey lighten-4" style="height:{{ mosaic_default_height }}px">
                                    <div class="spinner-border mt-10p" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer for Mosaic -->
                            <div class="card-footer text-center py-0">
                                <div class="row align-items-center">
                                    <nav aria-label="Bin Paging" class="w-50">
                                        <ul id="bin-paging" class="pagination pg-dark pagination-sm justify-content-center" style="display:none">
                                            <li class="page-item page-previous disabled">
                                                <a class="page-link" tabindex="-1">Previous</a>
                                            </li>
                                            <li class="page-item page-next">
                                                <a class="page-link">Next</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    <div class="dropdown w-50">
                                        <a class="btn btn-sm btn-mdb-color" href="#" role="button" id="mosaicConfigMenuLink"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas fa-cogs"></i>
                                        </a>
                                        <div class="dropdown-menu">
                                            <form class="px-4 py-3">
                                                <label class="my-1 mr-2" for="view-size">View Size:</label>
                                                <select id="view-size" class="custom-select custom-select-sm form-control" name="view-size">
                                                    {% for size in mosaic_view_sizes %}
                                                    <option value="{{ size }}" autocomplete="off" {% if size == mosaic_default_view_size %}selected{% endif %}>{{ size }}</option>
                                                    {% endfor %}
                                                </select>

                                                <label class="my-1 mr-2 pl-2" for="scale-factor">Scale Factor:</label>
                                                <select id="scale-factor" class="custom-select custom-select-sm form-control" name="scale-factor">
                                                    {% for factor in mosaic_scale_factors %}
                                                    <option value="{{ factor }}" autocomplete="off" {% if factor == mosaic_default_scale_factor %}selected{% endif %}>{{ factor }}%</option>
                                                    {% endfor %}
                                                </select>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right side of outer card area (details/images/etc) -->
                    <div class="col-xl-3 mt-2 mt-xl-0">
                        <div class="card">
                            <div class="card-body">
                                <!-- Bin stats -->
                                <dl class="row">
                                    <dt class="col-sm-5">Date/Time:</dt>
                                    <dd class="col-sm-7" id="stat-date-time"></dd>
                                    <dt class="col-sm-5">Instrument:</dt>
                                    <dd class="col-sm-7" id="stat-instrument"></dd>

                                    <dt class="col-sm-5">Triggers:</dt>
                                    <dd class="col-sm-7">{{ bin.n_triggers }}</dd>
                                    <dt class="col-sm-5">Images:</dt>
                                    <dd class="col-sm-7">{{ bin.n_images }}</dd>
                                    <dt class="col-sm-5">Triggers / s:</dt>
                                    <dd class="col-sm-7">{{ bin.trigger_frequency|floatformat:3 }}</dd>
                                    <dt class="col-sm-5">Volume Analyzed:</dt>
                                    <dd class="col-sm-7">{{ bin.ml_analyzed|floatformat:3 }} ml</dd>
                                </dl>

                                <!-- Download links -->
                                <p class="h5-responsive">Download:</p>
                                <div class="row">
                                    <div class="col">
                                        <ul class="list-unstyled">
                                            <li><a id="download-adc" href="#">ADC</a></li>
                                            <li><a id="download-hdr" href="#">HDR</a></li>
                                            <li><a id="download-roi" href="#">ROI</a></li>
                                            <li><a id="download-zip" href="#">ZIP</a></li>
                                        </ul>
                                    </div>
                                    <div class="col">
                                        <ul class="list-unstyled">
                                            <li>
                                                <a id="download-blobs" href="#" style="display:none">blobs</a>
                                                <span id="download-blobs-disabled">blobs</span>
                                            </li>
                                            <li>
                                                <a id="download-features" href="#" style="display:none">features</a>
                                                <span id="download-features-disabled">features</span>
                                            </li>
                                            <li>autoclass</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom half (metadata/tags) -->
                <div class="row mt-3">
                    <!-- Metadata -->
                    <div class="col-lg-10 mt-2 mt-lg-0">
        <div class="card vh-50 h-100">
            <div class="card-header py-1 mdb-color lighten-5">
                <span class="h5-responsive">Metadata</span>
            </div>
            <div class="card-body overflow-auto">
                <div class="table-responsive text-nowrap">
                    <table class="table table-striped table-sm table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Field</th>
                                <th scope="col">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for k, v in bin.metadata.items %}
                            <tr>
                                <th scope="row">{{ k }}</th>
                                <td>{{ v }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>

                    <!-- Tags -->
                    <div class="col-md-4 col-lg-2 mt-2 mt-lg-0">
        <div class="card h-100">
            <div class="card-header py-1 mdb-color lighten-5">
                <div class="row">
                    <div class="col">
                        <span class="h5-responsive">Tags</span>
                    </div>
                </div>
            </div>
            <div class="card-body overflow-auto">
                    {% for tag in details.tags %}
                    <li class="list-group-item">
                        <a href="#" class="badge badge-pill badge-primary"><i class="fas fa-tag fa-2x mr-1" aria-hidden="true"></i>{{tag}}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-footer py-1 white">
                <a href="#" class="btn btn-mdb-color btn-block btn-sm"><i class="fas fa-plus-circle" aria-hidden="true"></i>Add</a>
            </div>
        </div>
    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal" id="image-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 align-self-center text-center h-100" id="images">
                                <div class="row text-center">
                                <div class="col">
                                <a id="detailed-image-link" href="#">
                                    <img class="img-fluid mb-2 align-middle" id="detailed-image" src="data:image/png;base64,{{image}}" />
                                    <img class="img-fluid mb-2 align-middle" id="detailed-image-blob" src="" style="display:none" />
                                    <img class="img-fluid mb-2 align-middle" id="detailed-image-outline" src="" style="display:none" />
                                </a>
                                </div>
                            </div>
                            <div class="row text-center">
                            <div class="col">
                                <a class="btn btn-mdb-color btn-sm change-image" data-target="detailed-image" href="javascript:void(0)">Image</a>
                                <a class="btn btn-mdb-color btn-sm change-image {% if not details.has_blobs %}disabled{% endif %}" data-target="detailed-image-blob" href="javascript:void(0)" id="detailed-image-blob-link">Blob</a>
                                <a class="btn btn-mdb-color btn-sm change-image {% if not details.has_blobs %}disabled{% endif %}" data-target="detailed-image-outline" href="javascript:void(0)" id="detailed-image-outline-link">Outline</a>
                            </div>
                            </div>
                        </div>
                            <div class="col-md-6 h-100">
                                <p class="h5-responsive border-bottom">Metadata</p>
                                <div class="h300 overflow-auto">
                                    <div class="table-responsive text-nowrap overflow-auto">
                                        <table class="table table-striped table-sm table-hover" id="detailed-image-metadata">
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
            <div class="modal-footer py-0">
                    <a id="detailed-image-button" href="#" class="btn btn-mdb-color btn-sm">View Details</a>
                    <button type="button" class="btn btn-mdb-color btn-sm" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal" id="share-modal" tabindex="-1" role="dialog" aria-labelledby="share-modal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share This Dataset</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="share-link" size="50" data-scheme="{{ request.scheme }}" data-host="{{ request.get_host }}" />
            </div>
            <div class="modal-footer">
                <button id="copy-share-link" type="button" class="btn btn-mdb-color btn-sm">Copy to Clipboard</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script type="text/javascript" src="{% static 'js/bin.js' %}"></script>
<script>

var dataset_name = "{% if dataset %}{{ dataset.name }}{% endif %}";

var map;
var mapMarker;
var plot;
var currentBinPage = 0;
var numBinPages = -1;
var currentBinId = "";
var currentMetric = "";
var currentResolution = "auto";
var currentBinTimestamp = null;
var currentPlotId = "ts-concentration";

var timelineValid = true;
var timelineRelayoutResponse;
var timelineLocked = false;
var timelineLoadedAt = new Date();
var timelineLockedAt = new Date();
var timelineWaiting = 0;
var timelineWaitingSince = new Date();

var _attempts = 0;
var _requests = 0;



function updatePaging() {
    $(".page-previous").toggleClass("disabled", (currentBinPage <= 0));
    $(".page-next").toggleClass("disabled", (currentBinPage >= numBinPages));

    $.each($(".page-index a"), function() {
        var isSelected = $(this).data("page") == currentBinPage;

        $(this).closest("li").toggleClass("active", isSelected);
    });

    $("#bin-paging").show();
}

function changeToClosestBin(targetDate) {
    if (_isBinLoading || _isMosaicLoading)
        return false;

    _isBinLoading = true;
    _isMosaicLoading = true;

    var url = "{% url 'closest_bin' 'DATASET_NAME' %}";
    url = url.replace("DATASET_NAME", dataset_name);

    $.post(url, {"target_date": targetDate}, function(resp){
        if (resp.bin_id != "")
            changeBin(resp.bin_id, true);
    });
}

function changeToNearestBin(lat, lng) {
    if (_isBinLoading || _isMosaicLoading)
        return false;

    _isBinLoading = true;
    _isMosaicLoading = true;

    var url = "{% url 'nearest_bin' %}";
    var data = {
        dataset: "{{ dataset.name }}",
        latitude: lat,
        longitude: lng
    };

    $.post(url, data, function(resp){
        if (resp.bin_id != "")
            changeBin(resp.bin_id, true);
    });
}

function createTimeSeries(metric) {
    container = $("#primary-plot-container");

    currentMetric = metric;
    var dataUrl = "/api/{{ dataset.name }}/time-series/" + metric + "?resolution=auto";

    plot = Plotly.d3.json(dataUrl, function(err, response) {
        currentResolution = response["resolution"];

        var initialConfig = getTimelineConfig();
        var initialData = getTimelineData(response, currentBinTimestamp);
        var initialLayout = getTimelineLayout(response);

        Plotly.newPlot(container[0], initialData, initialLayout, initialConfig);

        if (currentBinTimestamp != null) {
            highlightSelectedBinByDate(container[0].data[0].x, currentBinTimestamp);
        }

        // Add event to locate nearest bin to user's click
        container[0].addEventListener('mousemove', function(event) {
            var xaxis = container[0]._fullLayout.xaxis;
            var margin = container[0]._fullLayout.margin.l;
            var containerMargin = $(container[0]).offset().left;
            var x = xaxis.p2c(event.x - margin - containerMargin);
            var date = (new Date(x)).toISOString();
            $(container[0]).data('date', date);
        });

        container[0].addEventListener('click', function(event) {
            // Prevent clicks on plotly controls (modebar actions)
            if ($(event.target).parents(".modebar").length > 0) {
                return
            }

            _coordinates = [];
            $("#previous-bin").addClass("disabled");
            $("#next-bin").addClass("disabled");

            changeToClosestBin($(container[0]).data("date"));
        });

        // Add event to handle resolution change when zooming
        container[0].on("plotly_relayout", function(relayoutResponse){
            timelineValid = false;
            timelineRelayoutResponse = relayoutResponse;

            // Prevent relayout's when switching to pan or zoom "mode"
            if (relayoutResponse && (relayoutResponse.dragmode == "pan" || relayoutResponse.dragmode == "zoom")) {
                return
            }

            queryTimeline(container, metric);
        });
    });
}

function queryTimeline(container, metric) {
    _attempts += 1;

    //
    var now = new Date();
    var ok = moment(timelineLoadedAt).add(1,"s").toDate();

    if (timelineLocked || now < ok) {
        // if a timeline query is underway, or it's not time to make another one,
        // and we're not already deferring an attempt, defer one for 100ms
        if (timelineWaiting == 0) {
            timelineWaiting += 1;
            setTimeout(function() {
                timelineWaiting -= 1;
                queryTimeline(container, metric);
            }, 10);
        }
        return false;
    }

    // lock the timeline
    timelineLocked = true;

    // prepare the time range query
    var start = timelineRelayoutResponse["xaxis.range[0]"];
    var end = timelineRelayoutResponse["xaxis.range[1]"];

    var url = "/api/{{ dataset.name }}/time-series/" + metric +
        "?resolution=" + "auto";
    if(start)
        url += "&start=" + start;
    if(end)
        url += "&end=" + end;

    // validate the timeline, so that upon return from
    // the AJAX call we know if it's been invalidated in the meantime
    timelineValid = true;

    $.get(url, function(dataResponse) {

        // the timeline has been invalidated so this response is out of date
        // if we're not already deferring an attempt, do so
        if (!timelineValid) {
            queryTimeline(container, metric);
        }

        // the user has not invalidated the timeline since we made the
        // request, so use this response
        currentResolution = dataResponse["resolution"];

        var updatedConfig = getTimelineConfig();
        var updatedData = getTimelineData(dataResponse, currentBinTimestamp);
        var updatedLayout = getTimelineLayout(dataResponse, timelineRelayoutResponse);

        Plotly.react(container[0], updatedData, updatedLayout, updatedConfig);

        // success, unlock the timeline
        timelineValid = true;
        timelineLoadedAt = new Date();
        timelineLocked = false;
        return false;
    });
    _requests += 1;
    return true;
}

$("#ts-tabs .nav-link").click(function() {
    $("#" + currentPlotId).hide();

    currentPlotId = $(this).data("target");

    $("#" + currentPlotId).show();

    var metric = $(this).data("metric");

    timelineValid = false;
    timelineWaiting = false;
    createTimeSeries(metric);
});

$("#view-size").change(function () {
    var viewSize = $("#view-size").val();
    var vs = viewSize.split("x");
    var height = parseInt(vs[1]);
    $('#mosaic-loading').height(height);
});

function changeBin(binId, updateHistory) {
    _coordinates = [];

    if (binId === "")
        return;

    _bin = binId;

    var viewSize = $("#view-size option:selected").val();
    var scaleFactor = $("#scale-factor option:selected").val();

    var binUrl = "{% url 'bin' '__DATASET_NAME__' '__BIN_PID__' %}".replace("__BIN_PID__", binId).replace("__DATASET_NAME__", dataset_name);
    var dataUrl = "{% url 'bin_data' '__DATASET_NAME__' '__BIN_PID__' %}".replace("__BIN_PID__", binId).replace("__DATASET_NAME__", dataset_name);
    dataUrl += "?view_size=" + viewSize;
    dataUrl += "&scale_factor=" + scaleFactor;
    dataUrl += "&preload_adjacent_bins=" + true;
    dataUrl += "&include_coordinates=" + false;

    // This also gets called when changing the mosaic, but do it earlier here to indicate the bin is loading as well
    $("#mosaic-loading").show();
    $("#mosaic").hide().attr("src","");

    // The map must be made invisible, rather than hidden, or the Leaflet will not render the map at the correct
    //   position when it finishes loading. the leaflet control container must be hidden completely as well or there
    //   will be a split second where the controls are visible but the map is not
    $("#mapid").css("visibility", "hidden");
    $("#mapid .leaflet-control-container").hide();

    // Update bin name/link
    $("#bin-header").attr("href", binUrl).html(binId);

    // disable next/previous buttons
    $("#previous-bin").addClass("disabled");
    $("#next-bin").addClass("disabled");

    currentBinId = binId;
    currentBinPage = 0;
    delayedMosaic(0);

    $.get(dataUrl, function(data){
        updateBinStats(data);
        currentBinTimestamp = moment(data["timestamp_iso"]);

        $("#previous-bin").data("bin", data.previous_bin_id);
        $("#next-bin").data("bin", data.next_bin_id);

        // Update outline/blob links
        $("#detailed-image-blob-link").toggleClass("disabled", !data["has_blobs"]);
        $("#detailed-image-outline-link").toggleClass("disabled", !data["has_blobs"]);

        // Update download links
        $("#download-adc").attr("href", "{% url 'adc_csv' 'xxx' '_BIN_' %}".replace('_BIN_', binId));
        $("#download-hdr").attr("href", "{% url 'hdr_text' 'xxx' '_BIN_' %}".replace('_BIN_', binId));
        $("#download-roi").attr("href", "{% url 'roi_binary' 'xxx' '_BIN_' %}".replace('_BIN_', binId));
        $("#download-zip").attr("href", "{% url 'zip' 'xxx' '_BIN_' %}".replace('_BIN_', binId));
        $("#download-blobs").attr("href", "{% url 'blob_zip' 'xxx' '_BIN_' %}".replace('_BIN_', binId));
        $("#download-features").attr("href", "{% url 'features_csv' 'xxx' '_BIN_' %}".replace('_BIN_', binId));

        $("#download-blobs").toggle(data["has_blobs"]);
        $("#download-blobs-disabled").toggle(!data["has_blobs"]);

        $("#download-features").toggle(data["has_features"]);
        $("#download-features-disabled").toggle(!data["has_features"]);

        // Update map location(s)
        if (!map) {
            map = createMap(data.lat, data.lng);
            map.on("click", function(e){
                changeToNearestBin(e.latlng.lat,e.latlng.lng);
            });
        }
        mapMarker = changeMapLocation(map, data.lat, data.lng, data.depth, mapMarker);
        $("#mapid").css("visibility", "visible");
        $("#mapid .leaflet-control-container").show()

        if (updateHistory) {
            history.pushState({"bin_id": binId}, null, "?bin_id=" + binId);
        }

        // Update the timeline to select the new bin
        var timeline = $("#primary-plot-container")[0];
        highlightSelectedBinByDate(timeline.data[0].x, currentBinTimestamp);

        _isBinLoading = false;
    });
}

$("#previous-bin, #next-bin").click(function(e){
    e.preventDefault();

    changeBin($(this).data("bin"), true);
});

$("#bin-paging").on("click", ".page-previous", function(e){
    e.preventDefault();

    if (currentBinPage > 0)
        changeMosaicPage(currentBinPage - 1);
});

$("#bin-paging").on("click", ".page-next", function(e){
    e.preventDefault();

    if (currentBinPage < numBinPages)
        changeMosaicPage(currentBinPage + 1);
});

$("#bin-paging").on("click", ".page-index a", function(e){
    e.preventDefault();

    var pageNumber = $(this).data("page")

    changeMosaicPage(pageNumber);
});

$("#view-size").change(function(e){
    changeBin(currentBinId, true);
});

$("#scale-factor").change(function(e){
    changeBin(currentBinId, true);
});

$("#mosaic").click(function(e){
    var x = e.pageX - $(this).offset().left;
    var y = e.pageY - $(this).offset().top;

    $.each(_coordinates, function(idx, img) {
        if (currentBinPage == img.page &&
            x >= img.x && x <= img.x + img.width &&
            y >= img.y && y <= img.y + img.height) {

            // TODO: Need to handle routing from Django
            // TODO: Needs loading indicator
            // TODO: Is png the right default format
            var baseUrl = "/{{ dataset.name }}/" + currentBinId + "_" + padDigits(img.pid, 5);
            var metaUrl = "/api/image/" + currentBinId + "/" + img.pid;

            changeImage($("#detailed-image"), baseUrl + ".png", $("#detailed-image-blob"), $("#detailed-image-outline"));
            $("#detailed-image").data("image-id", img.pid);
            $("#detailed-image-link").attr("href", baseUrl + ".html");
            $("#detailed-image-button").attr("href", baseUrl + ".html");
            $("#image-modal").modal();

            $("#detailed-image-metadata tbody").empty();
            $.get(metaUrl, function(data){
                $.each(data, function(key, val) {
                    var tr = $("<tr />");
                    tr.append($("<th>").html(key));
                    tr.append($("<td>").attr("scope", "row").html(val));
                    $("#detailed-image-metadata tbody").append(tr);
                });

            });

            return false;
        }
    });
});

$("#image-modal").on("hidden.bs.modal", function() {
    $("#detailed-image").attr("src","");
    $("#detailed-image-blob").attr("src","");
    $("#detailed-image-outline").attr("src","");
});

$(".change-image").click(function(e){
    var target = $(this).data("target");

    var pixel = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";

    $.each($("#images img"), function(){
        var id = $(this).attr("id");

        $(this).toggle(id == target);
    });

    // TODO: Implement Django routes instead of hardcoded ones
    if (target == "detailed-image-blob" && $("#detailed-image-blob").attr("src") === "") {
        var blobUrl = "/api/blob/" + currentBinId + "/" + $("#detailed-image").data("image-id");

        $("#detailed-image-blob").attr("src", pixel);

        $.get(blobUrl, function(data){
            if (data["blob"] != "")
                $("#detailed-image-blob").attr("src", "data:image/png;base64," + data["blob"]);
        });
    }

    if (target == "detailed-image-outline" && $("#detailed-image-outline").attr("src") === "") {
        var outlineUrl = "/api/outline/" + currentBinId + "/" + $("#detailed-image").data("image-id");

        $("#detailed-image-outline").attr("src", pixel);

        $.get(outlineUrl, function(data){
            if (data["outline"] != "")
                $("#detailed-image-outline").attr("src", "data:image/png;base64," + data["outline"]);
        });
    }
});


$(function() {
    {% if dataset %}
    createTimeSeries("concentration");
    {% endif %}

    changeBin("{{ bin.pid }}", false);
});




$("#show-plot").click(function(e){
    $("#image-tab").toggleClass("d-none", true);
    $("#plot-tab").toggleClass("d-none", false);
    $("#map-tab").toggleClass("d-none", true);
});

$("#show-mosaic").click(function(e){
    $("#image-tab").toggleClass("d-none", false);
    $("#plot-tab").toggleClass("d-none", true);
    $("#map-tab").toggleClass("d-none", true);
});

$("#show-map").click(function(e){
    $("#image-tab").toggleClass("d-none", true);
    $("#plot-tab").toggleClass("d-none", true);
    $("#map-tab").toggleClass("d-none", false);
});


    function updatePlot() {
        var xAxis = $("#plot-x-axis").val();
        var yAxis = $("#plot-y-axis").val();
        var xType = $("#plot-x-type").val();
        var yType = $("#plot-y-type").val();
        var xOffset = $("#plot-x-offset").val();
        var yOffset = $("#plot-y-offset").val();
        var xData = _plotData[xAxis];
        var yData = _plotData[yAxis];

        if ($.isNumeric(xOffset) && xOffset != 0) {
            xData = $.map(xData, function(value) { return value + parseFloat(xOffset); });
        }

        if ($.isNumeric(yOffset) && yOffset != 0) {
            yData = $.map(yData, function(value) { return value + parseFloat(yOffset); });
        }

        var config = {
            responsive: true,
            displaylogo: false,
            scrollZoom: true,
            modeBarButtonsToRemove: [
                "sendDataToCloud",
                "hoverCompareCartesian",
                "hoverClosestCartesian",
                "toImage",
                "toggleSpikelines",
                "resetScale2d"
            ]
        };

        var trace = [{
            x: xData,
            y: yData,
            mode: 'markers',
            type: 'scatter'
        }];

        var layout = {
                margin: {
                    l: 50,
                    r: 50,
                    b: 50,
                    t: 00,
                    pad: 2
                },
            xaxis: {
                type: xType,
                autorange: true
            },
            yaxis: {
                type: yType,
                fixedrange: true,
            }
        };

        Plotly.react('plot', trace, layout, config);

        $("#plot")[0].on('plotly_click', function(data){
            var pts = '';
            for(var i=0; i < data.points.length; i++){
                var idx = data.points[i].pointIndex;

                var imageId = _plotData["target_number"][idx];
                var baseUrl = "/" + dataset_name + "/" + currentBinId + "_" + padDigits(imageId, 5) + ".png";

                $("#plot-images").empty();
                $("#plot-images").append(
                    $("<img />")
                        .attr("src", baseUrl)
                        .attr("data-target", imageId)
                );
            }
        });

        $("#plot")[0].on("plotly_selected", function(data){
            var urls = [];
            var maxImages = false;
            for(var i = 0; i < data.points.length; i++){
                if (i == MAX_SELECTABLE_IMAGES) {
                    maxImages = true;
                    break;
                }

                var idx = data.points[i].pointIndex;
                var imageId = _plotData["target_number"][idx];
                var imageUrl = "/" + dataset_name + "/" + currentBinId + "_" + padDigits(imageId, 5) + ".png";

                urls.push({
                    "id": imageId,
                    "url": imageUrl
                });
            }

            $("#plot-images").empty();
            $.each(urls, function(key, val){
                $("#plot-images").append($("<img />")
                    .attr("src", val.url)
                    .attr("data-target", val.id));
            });
            $("#too-many-images").toggle(maxImages);
        });
    }

    $("#plot-x-axis, #plot-y-axis, #plot-x-offset, #plot-y-offset").change(function(e){
        updatePlot();
    });

    $("#plot-x-type").change(function(e){
        if ($(this).val() == "log") {
            $("#plot-x-offset").prop("disabled", false);
        } else {
            $("#plot-x-offset").prop("disabled", true).val("");;
        }

        updatePlot();
    });

    $("#plot-y-type").change(function(e){
        if ($(this).val() == "log") {
            $("#plot-y-offset").prop("disabled", false);
        } else {
            $("#plot-y-offset").prop("disabled", true).val("");;
        }

        updatePlot();
    });

    $("#plot-images").on("click", "img", function(e){
        var target = $(this).data("target");
        var baseUrl = "/{{ dataset.name }}/{{ bin.pid }}_" + padDigits(target, 5);

        location.href = baseUrl + ".html";
    });

    {% if dataset %}
        _dataset = "{{ dataset.name }}";
    {% endif %}
    _bin = "{{ bin.pid }}";

</script>
{% endblock %}