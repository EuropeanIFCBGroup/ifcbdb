{% extends 'base.html' %} {% block breadcrumbs %}
<li class="breadcrumb-item"><a class="black-text" href="{% url 'dataset' dataset.name %}">{{ dataset.name }}</a></li>
{% endblock %} {% block content %}
<div class="row d-flex justify-content-between">
    <div class="pl-3">
        <span class="h2-responsive">{{ dataset.title }}</span>
    </div>
    {% if user.is_authenticated %}
    <div>
        <a href="#" class="btn btn-sm btn-primary ml-3">Configure</a>
    </div>
    {% endif %}
        <ul class="nav justify-content-end" id="ts-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-size-tab" data-toggle="tab" data-metric="size" href="#ts-size"
                   role="tab" aria-controls="ts-size" aria-selected="true">Data Size</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-temperature-tab" data-toggle="tab" data-metric="temperature" href="#ts-temperature"
                   role="tab" aria-controls="ts-temperature" aria-selected="false">Temperature</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-humidity-tab" data-toggle="tab" data-metric="humidity" href="#ts-humidity"
                   role="tab" aria-controls="ts-humidity" aria-selected="false">Humidity</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-ml-analyzed-tab" data-toggle="tab" data-metric="ml-analyzed" href="#ts-ml-analyzed"
                   role="tab" aria-controls="ts-ml-analyzed" aria-selected="false">Volume Imaged</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-concentration-tab" data-toggle="tab" data-metric="concentration" href="#ts-concentration"
                   role="tab" aria-controls="ts-concentration" aria-selected="false">Concentration</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-triggers-tab" data-toggle="tab" data-metric="n-triggers" href="#ts-triggers"
                   role="tab" aria-controls="ts-triggers" aria-selected="false">Trigger Count</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-images-tab" data-toggle="tab" data-metric="n-images" href="#ts-images"
                   role="tab" aria-controls="ts-images" aria-selected="false">Image Count</a>
            </li>
        </ul>
</div>
<hr class="my-2">
<div class="row px-1">
    <div class="col-sm-12">
        <div class="tab-content" id="ts-data">
            <div class="tab-pane show active" id="ts-size" role="tabpanel" aria-labelledby="ts-size-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-temperature" role="tabpanel" aria-labelledby="ts-temperature-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-humidity" role="tabpanel" aria-labelledby="ts-humidity-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-ml-analyzed" role="tabpanel" aria-labelledby="ts-ml-analyzed-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-concentration" role="tabpanel" aria-labelledby="ts-concentration-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-triggers" role="tabpanel" aria-labelledby="ts-triggers-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-images" role="tabpanel" aria-labelledby="ts-images-tab">
                <div class="ts-plot-container"></div>
            </div>
        </div>
    </div>
</div>
<div class="row py-2">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header py-1 white">
                <div class="d-flex flex-row justify-content-between">
                    <div class="flex-column">
                        <form class="form-inline">
                            <a href="#" id="previous-bin" data-bin="" class="btn btn-mdb-color btn-sm"><i class="fas fa-arrow-circle-left fa-1x"></i></a>
                        </form>
                    </div>
                    <div class="flex-column text-center">
                        <span class="p">
                        <strong>Selected Bin:</strong>
                        <a id="bin-header" href="{% url 'bin' dataset.name bin.pid %}">{{ bin.pid }}</a>
                    </span>
                    </div>
                    <div class="flex-column pt-1 pt-sm-0">
                        <form class="form-inline">
                            <a href="#" id="next-bin" data-bin="" class="btn btn-mdb-color btn-sm"><i class="fas fa-arrow-circle-right fa-1x"></i></a>
                        </form>
                    </div>
                </div>
            </div>
        <div class="card-body">
        <div class="row">
    <div class="col-lg-6 col-xl-9">
        <div class="card h-100">
    <div class="card-header py-1 white">
                            <form class="form-inline justify-content-end">
                                    <label class="my-1 mr-2" for="view-size">View Size:</label>
                                    <select id="view-size" class="custom-select custom-select-sm form-control" name="view-size">                                  
                                    {% for size in mosaic_view_sizes %}
                                    <option value="{{ size }}" autocomplete="off" {% if size == mosaic_default_view_size %}selected{% endif %}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                                    <label class="my-1 mr-2 pl-2" for="scale-factor">Scale Factor:</label>                                    
                                    <select id="scale-factor" class="custom-select custom-select-sm form-control" name="scale-factor">                                  
                                    {% for factor in mosaic_scale_factors %}
                                    <option value="{{ factor }}" autocomplete="off" {% if factor == mosaic_default_scale_factor %}selected{% endif %}>{{ factor }}%</option>
                                    {% endfor %}                                 
                                    </select>
                                </form>   
</div>
            <div class="card-body text-center">                
                <img class="img-fluid" id="mosaic" src="" data-toggle="modal" data-target="#exampleModalCenter" style="display:none" />
                <div id="mosaic-loading" class="loading h-100">
                    <div class="loader"></div>
                    loading...
                </div>
                <br clear="all" />
            </div>
            <div class="card-footer py-1 text-center white">
                <nav aria-label="Bin Paging" class="text-center">
                    <ul id="bin-paging" class="pagination pg-dark justify-content-center">
                        <li class="page-item page-previous disabled">
                            <a class="page-link" tabindex="-1">Previous</a>
                        </li>

                        <li class="page-item page-next">
                            <a class="page-link">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xl-3 mt-2 mt-md-0">
            <div class="card h-50">
                    <div class="card-header white py-1">
<p>Download:</p>
            </div>
            <div class="card-body">
            <div class="row">
            <div class="col">
            <ul class="list-unstyled">
                <li><a href="{% url 'adc_csv' dataset.name bin.pid %}">ADC</a></li>
                <li><a href="{% url 'hdr_text' dataset.name bin.pid %}">HDR</a></li> 
                <li><a href="{% url 'roi_binary' dataset.name bin.pid %}">ROI</a></li> 
                <li><a href="{% url 'zip' dataset.name bin.pid %}">ZIP</a></li> 
                </ul>
            </div>
            <div class="col">
            <ul class="list-unstyled">       
                <li><a href="{% url 'blob_zip' dataset.name bin.pid %}">blobs</a></li> 
                <li><a href="#">features</a></li> 
                <li><a href="#">autoclass</a></li>
            </ul>
            </div>            
            </div>
            </div>
        </div>
        <div class="card h-50">
            <div class="card-body">
                <div id="mapid" class="h-75"></div>
                <p>41 north, 82 east (41.31, -70.39), depth 5m</p>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>
<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">

    <!-- Add .modal-dialog-centered to .modal-dialog to vertically center the modal -->
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">


        <div class="modal-content">
            <div class="modal-body">
                <img class="img-fluid" id="bin-mosaic" src="data:image/png;base64,{{image}}" />
            </div>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
var map;
var plot;
var currentMosaicPage = 1;
var currentBinPage = 0;
var numBinPages = 0;
var currentBinId = "";

function changeToClosestBin(targetDate) {
    var url = "{% url 'closest_bin' dataset.name %}";

    $.post(url, {"target_date": targetDate}, function(resp){
        if (resp.bin_id != "")
            changeBin(resp.bin_id, true);
    });
}

function createTimeSeries(container, metric) {
    var dataUrl = "/api/{{ dataset.name }}/time-series/" + metric;

    plot = Plotly.d3.json(dataUrl, function(err, response) {
        var data = [{
            type: "bar",
            x: response["x"],
            y: response["y"],
            line: {
                color: '#17BECF'
            },
        }];


        var layout = {
            bargap: .05,
            margin: {
                l: 50,
                r: 50,
                b: 50,
                t: 00,
                pad: 2
            },
            yaxis: {
                title: {
                    text: response["y-axis"]
                }
            },
            "xaxis": {
                showspikes: true,
                spikethickness: 1,
                spikedash: "solid",
                spikemode: "across+toaxis",
                spikesnap: "cursor",
                spikecolor: "#000"
            }
        };

        var config = {
            responsive: true,
            displaylogo: false,
            scrollZoom: true
        };

        Plotly.newPlot(container[0], data, layout, config);

        // Add event to locate nearest bin to user's click
        container[0].on("plotly_click", function(d){
            changeToClosestBin(d.points[0].x);
        });

        // Add event to handle resolution change when zooming
        container[0].on("plotly_relayout", function(d){
            
        });
    });

}

$("#bin-details").click(function(e) {
    var url = "{% url 'bin' dataset.name '__BIN_PID__' %}";
    var pid = $("#bin-switcher").val();

    location.href = url.replace("__BIN_PID__", pid);
});

$("#ts-tabs .nav-link").click(function() {
    var metric = $(this).data("metric");
    var container = $("#" + $(this).attr("aria-controls") + " .ts-plot-container")

    createTimeSeries(container, metric);
});

function changeBin(binId, updateHistory) {
    if (binId === "")
        return;

    var viewSize = $("#view-size input[type=select]:selected").val();
    var scaleFactor = $("#scale-factor input[type=select]:selectedIndex").val();

    var binUrl = "{% url 'bin' dataset.name '__BIN_PID__' %}".replace("__BIN_PID__", binId);

    var dataUrl = "{% url 'bin_data' dataset.name '__BIN_PID__' %}".replace("__BIN_PID__", binId);
    dataUrl += "?view_size=" + viewSize;
    dataUrl += "&scale_factor=" + scaleFactor;

    // This also gets called when changing the mosaic, but do it earlier here to indicate the bin is loading as well
    $("#mosaic-loading").show();
    $("#mosaic").hide();

    $.get(dataUrl, function(data){
        currentBinId = binId;

        // Update bin name/link
        $("#bin-header").attr("href", binUrl).html(binId);

        // Update bin paging
        currentBinPage = 0;
        numBinPages = data.num_pages;

        $("#previous-bin")
            .data("bin", data.previous_bin_id)
            .toggleClass("disabled", data.previous_bin_id === "");

        $("#next-bin")
            .data("bin", data.next_bin_id)
            .toggleClass("disabled", data.next_bin_id === "");

        $(".page-index").remove();
        for (var i = 0; i < numBinPages + 1; i++) {
            var li = $("<li class='page-item page-index' />").toggleClass("active", i == 0);
            var btn = $("<a class='page-link' />").text(i + 1).attr("data-page", i);

            li.append(btn).insertBefore($(".page-next"));
        }

        // Update map location(s)
        // TODO: Need a loading panel around the map
        if (data.lat == 0 || data.lng == 0) {
            // TODO: Need some indication there is no location (not just default map location)
            map.setView([41.5507768, -70.6593102], 11);
        } else {
            map.setView([data.lng, data.lat], 11);
        }

        if (updateHistory) {
            history.pushState(null, null, "?bin_id=" + binId);
        }

        // Update mosaic; save this for last since it will require and additional ajax request
        loadMosaic(0);
    });
}

function loadMosaic(pageNumber) {
    $("#mosaic-loading").show();
    $("#mosaic").hide();

    var viewSize = $("#view-size option:selected").val();
    var scaleFactor = $("#scale-factor option:selected").val();

    // TODO: Need to pass in scale/width/height from UI controls
    // TODO: Needs error handling if mosaic cannot be generated
    var mosaicUrl = "{% url 'mosaic_page_encoded_image' "__BIN_PID__" %}" +
        "?view_size=" + viewSize +
        "&scale_factor=" + scaleFactor +
        "&page=" + pageNumber;
    mosaicUrl = mosaicUrl.replace("__BIN_PID__", currentBinId);

    $.get(mosaicUrl, function(data){
        $("#mosaic").attr("src", "data:image/png;base64," + data);
        $("#mosaic-loading").hide();
        $("#mosaic").show();
    });
}

$("#previous-bin, #next-bin").click(function(e){
    e.preventDefault();

    changeBin($(this).data("bin"), true);
});

$("#bin-paging").on("click", ".page-previous", function(e){
    e.preventDefault();

    if (currentBinPage > 0)
        changePage(currentBinPage - 1);
});

$("#bin-paging").on("click", ".page-next", function(e){
    e.preventDefault();

    if (currentBinPage < numBinPages)
        changePage(currentBinPage + 1);
});

$("#bin-paging").on("click", ".page-index a", function(e){
    e.preventDefault();

    var pageNumber = $(this).data("page")

    changePage(pageNumber);
});


function changePage(pageNumber) {
    currentBinPage = pageNumber;

    $(".page-previous").toggleClass("disabled", (pageNumber <= 0));
    $(".page-next").toggleClass("disabled", (pageNumber >= numBinPages));

    $.each($(".page-index a"), function(){
        var isSelected = $(this).data("page") == pageNumber;

        $(this).closest("li").toggleClass("active", isSelected);
    });

    loadMosaic(pageNumber);
}

$("#view-size").change(function(e){
    changeBin(currentBinId, true);
});

$("#scale-factor").change(function(e){
    changeBin(currentBinId, true);
});

$(function() {
    // TODO: Fill in proper values and a real default starting location
    map = createMap(41.5507768, -70.6593102);

    createTimeSeries($("#ts-size .ts-plot-container"), "size");

    changeBin("{{ bin.pid }}", false);
});
</script>
{% endblock %}