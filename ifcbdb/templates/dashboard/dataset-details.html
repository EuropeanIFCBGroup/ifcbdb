{% extends 'base.html' %} {% block breadcrumbs %}
<li class="breadcrumb-item"><a class="black-text" href="{% url 'dataset' dataset.name %}">{{ dataset.name }}</a></li>
{% endblock %} {% block content %}
<div class="row d-flex justify-content-between">
    <div class="pl-3">
        <span class="h3-responsive">{{ dataset.title }}</span>
    </div>
    {% if user.is_authenticated %}
    <div>
        <a href="#" class="btn btn-sm btn-primary ml-3">Configure</a>
    </div>
    {% endif %}
        <ul class="nav justify-content-end" id="ts-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-size-tab" data-toggle="tab" data-metric="size" href="#ts-size"
                   role="tab" aria-controls="ts-size" aria-selected="true">Data Size</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-temperature-tab" data-toggle="tab" data-metric="temperature" href="#ts-temperature"
                   role="tab" aria-controls="ts-temperature" aria-selected="false">Temperature</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-humidity-tab" data-toggle="tab" data-metric="humidity" href="#ts-humidity"
                   role="tab" aria-controls="ts-humidity" aria-selected="false">Humidity</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-ml-analyzed-tab" data-toggle="tab" data-metric="ml-analyzed" href="#ts-ml-analyzed"
                   role="tab" aria-controls="ts-ml-analyzed" aria-selected="false">Volume Imaged</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-concentration-tab" data-toggle="tab" data-metric="concentration" href="#ts-concentration"
                   role="tab" aria-controls="ts-concentration" aria-selected="false">Concentration</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-triggers-tab" data-toggle="tab" data-metric="n-triggers" href="#ts-triggers"
                   role="tab" aria-controls="ts-triggers" aria-selected="false">Trigger Count</a>
            </li>
            <li class="nav-item">
                <a class="nav-link btn btn-mdb-color btn-sm" id="ts-images-tab" data-toggle="tab" data-metric="n-images" href="#ts-images"
                   role="tab" aria-controls="ts-images" aria-selected="false">Image Count</a>
            </li>
        </ul>
</div>
<hr class="my-2">
<div class="row px-1">
    <div class="col-sm-12">
        <div class="tab-content" id="ts-data">
            <div class="tab-pane show active" id="ts-size" role="tabpanel" aria-labelledby="ts-size-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-temperature" role="tabpanel" aria-labelledby="ts-temperature-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-humidity" role="tabpanel" aria-labelledby="ts-humidity-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-ml-analyzed" role="tabpanel" aria-labelledby="ts-ml-analyzed-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-concentration" role="tabpanel" aria-labelledby="ts-concentration-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-triggers" role="tabpanel" aria-labelledby="ts-triggers-tab">
                <div class="ts-plot-container"></div>
            </div>
            <div class="tab-pane" id="ts-images" role="tabpanel" aria-labelledby="ts-images-tab">
                <div class="ts-plot-container"></div>
            </div>
        </div>
    </div>
</div>
<div class="row py-2">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header py-1 white">
                <div class="d-flex flex-row justify-content-between">
                    <div class="flex-column">
                        <form class="form-inline">
                            <a href="#" id="previous-bin" data-bin="" class="btn btn-mdb-color btn-sm"><i class="fas fa-arrow-circle-left fa-1x"></i></a>
                        </form>
                    </div>
                    <div class="flex-column align-self-center">
                        <span class="p">
                        <strong>Selected Bin:</strong>
                        <a id="bin-header" href="{% url 'bin' dataset.name bin.pid %}">{{ bin.pid }}</a>
                    </span>
                    </div>
                    <div class="flex-column pt-1 pt-sm-0">
                        <form class="form-inline">
                            <a href="#" id="next-bin" data-bin="" class="btn btn-mdb-color btn-sm"><i class="fas fa-arrow-circle-right fa-1x"></i></a>
                        </form>
                    </div>
                </div>
            </div>
        <div class="card-body">
        <div class="row">
    <div class="col-lg-6 col-xl-9">
        <div class="card h-100 min-vh-50">
    <div class="card-header py-1 white">
                            <form class="form-inline justify-content-end">
                                    <label class="my-1 mr-2" for="view-size">View Size:</label>
                                    <select id="view-size" class="custom-select custom-select-sm form-control" name="view-size">                                  
                                    {% for size in mosaic_view_sizes %}
                                    <option value="{{ size }}" autocomplete="off" {% if size == mosaic_default_view_size %}selected{% endif %}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                                    <label class="my-1 mr-2 pl-2" for="scale-factor">Scale Factor:</label>                                    
                                    <select id="scale-factor" class="custom-select custom-select-sm form-control" name="scale-factor">                                  
                                    {% for factor in mosaic_scale_factors %}
                                    <option value="{{ factor }}" autocomplete="off" {% if factor == mosaic_default_scale_factor %}selected{% endif %}>{{ factor }}%</option>
                                    {% endfor %}                                 
                                    </select>
                                </form>   
</div>
            <div class="card-body text-center" id="image-tab">
                <img id="mosaic" src="" style="display:none" />
                <div id="mosaic-loading" style="height:{{ mosaic_default_height }}px">
                    <div class="spinner-border spinner-center" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                <br clear="all" />
            </div>
            <div class="card-footer py-1 text-center white">
                <nav aria-label="Bin Paging" class="text-center">
                    <ul id="bin-paging" class="pagination pg-dark justify-content-center" style="display:none">
                        <li class="page-item page-previous disabled">
                            <a class="page-link" tabindex="-1">Previous</a>
                        </li>

                        <li class="page-item page-next">
                            <a class="page-link">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xl-3 mt-2 mt-md-0">
        <div class="card h-50">
            <div class="card-body">
                <div id="mapid" class="h-75"></div>
                <p class="figure-caption">
                    <span class="text-nowrap"><strong>Latitude:</strong> {{ bin.latitude }}</span>,
                    <span class="text-nowrap"><strong>Longitude:</strong>{{ bin.longitude }}</span>,
                    <span class="text-nowrap"><strong>Depth</strong> {{ bin.depth }}m</span>
                </p>
            </div>
        </div>
            <div class="card h-50">
            <div class="card-body">
                <p class="h5-responsive">Download:</p>
                <div class="row">
                    <div class="col">
                        <ul class="list-unstyled">
                            <li><a href="{% url 'adc_csv' dataset.name bin.pid %}">ADC</a></li>
                            <li><a href="{% url 'hdr_text' dataset.name bin.pid %}">HDR</a></li> 
                            <li><a href="{% url 'roi_binary' dataset.name bin.pid %}">ROI</a></li> 
                            <li><a href="{% url 'zip' dataset.name bin.pid %}">ZIP</a></li> 
                        </ul>
                    </div>
                    <div class="col">
                        <ul class="list-unstyled">       
                            <li><a href="{% url 'blob_zip' dataset.name bin.pid %}">blobs</a></li> 
                            <li>features</li> 
                            <li>autoclass</li>
                        </ul>
                    </div>            
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>

<!-- Modal -->
<div class="modal" id="image-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 align-self-center text-center h-100" id="images">
                                <img class="img-fluid mb-2 align-middle" id="detailed-image" src="data:image/png;base64,{{image}}" />
                                <img class="img-fluid mb-2 align-middle" id="detailed-image-blob" src="" style="display:none" />
                                <img class="img-fluid mb-2 align-middle" id="detailed-image-outline" src="" style="display:none" />
                                <br />
                                <a class="btn btn-mdb-color btn-sm change-image" data-target="detailed-image" href="#">Image</a>
                                <a class="btn btn-mdb-color btn-sm change-image {% if not details.has_blobs %}disabled{% endif %}" data-target="detailed-image-blob" href="#" id="detailed-image-blob-link">Blob</a>
                                <a class="btn btn-mdb-color btn-sm change-image {% if not details.has_blobs %}disabled{% endif %}" data-target="detailed-image-outline" href="#" id="detailed-image-outline-link">Outline</a>
                            </div>
                            <div class="col-md-6 h-100">
                                <span class="h5-responsive">Metadata</span>
                                <div class="h300 overflow-auto">
                                    <div class="table-responsive text-nowrap overflow-auto">
                                        <table class="table table-striped table-sm table-hover" id="detailed-image-metadata">
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer white text-center">
                        <a id="detailed-image-link" href="#" class="btn btn-mdb-color btn-sm">View Details</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
var map;
var plot;
var currentBinPage = 0;
var numBinPages = -1;
var currentBinId = "";
var currentMetric = "";
var coordinates = [];

// TODO: Default resolution is week; it might be possible to calculate this based on the initial data on the timeline
var currentResolution = "week";

function delayedMosaic(page) {
        $("#mosaic").hide();
        $("#mosaic-loading").show();

        setTimeout(function(){
            loadMosaic(page);
        }, 50);
    }

function updatePaging() {
    $(".page-previous").toggleClass("disabled", (currentBinPage <= 0));
    $(".page-next").toggleClass("disabled", (currentBinPage >= numBinPages));

    $.each($(".page-index a"), function() {
        var isSelected = $(this).data("page") == currentBinPage;

        $(this).closest("li").toggleClass("active", isSelected);
    });

    $("#bin-paging").show();
}

function rebuildPageIndexes() {
    $(".page-index").remove();
    for (var i = 0; i < numBinPages + 1; i++) {
        var li = $("<li class='page-item page-index' />").toggleClass("active", i == 0);
        var btn = $("<a class='page-link' />").text(i + 1).attr("data-page", i);

        li.append(btn).insertBefore($(".page-next"));
    }

    $("#bin-paging").show();
}

function changeToClosestBin(targetDate) {
    var url = "{% url 'closest_bin' dataset.name %}";

    $.post(url, {"target_date": targetDate}, function(resp){
        if (resp.bin_id != "")
            changeBin(resp.bin_id, true);
    });
}

function createTimeSeries(container, metric) {
    currentMetric = metric;
    var dataUrl = "/api/{{ dataset.name }}/time-series/" + metric + "?resolution=" + currentResolution;

    plot = Plotly.d3.json(dataUrl, function(err, response) {
        currentResolution = response["resolution"];

        var initialConfig = getTimelineConfig();
        var initialData = getTimelineData(response);
        var initialLayout = getTimelineLayout(response);

        Plotly.newPlot(container[0], initialData, initialLayout, initialConfig);

        // Add event to locate nearest bin to user's click
        container[0].on("plotly_click", function(d){
            changeToClosestBin(d.points[0].x);
        });

        // Add event to handle resolution change when zooming
        container[0].on("plotly_relayout", function(relayoutResponse){
            var resolution = parseAndCalcResolution(relayoutResponse);
            if (resolution == currentResolution)
                return;

            $.get("/api/{{ dataset.name }}/time-series/" + metric + "?resolution=" + resolution, function(dataResponse) {
                var updatedConfig = getTimelineConfig();
                var updatedData = getTimelineData(dataResponse);
                var updatedLayout = getTimelineLayout(dataResponse, relayoutResponse);

                Plotly.react(container[0], updatedData, updatedLayout, updatedConfig);

                currentResolution = dataResponse["resolution"];
                return false;
            });
        });
    });
}

$("#bin-details").click(function(e) {
    var url = "{% url 'bin' dataset.name '__BIN_PID__' %}";
    var pid = $("#bin-switcher").val();

    location.href = url.replace("__BIN_PID__", pid);
});

$("#ts-tabs .nav-link").click(function() {
    var metric = $(this).data("metric");
    var container = $("#" + $(this).attr("aria-controls") + " .ts-plot-container")

    createTimeSeries(container, metric);
});

$("#view-size").change(function () {
    var viewSize = $("#view-size").val();
    var vs = viewSize.split("x");
    var height = parseInt(vs[1]);
    $('#mosaic-loading').height(height);
});

function changeBin(binId, updateHistory) {
    if (binId === "")
        return;

    var viewSize = $("#view-size input[type=select]:selected").val();
    var scaleFactor = $("#scale-factor input[type=select]:selectedIndex").val();

    var binUrl = "{% url 'bin' dataset.name '__BIN_PID__' %}".replace("__BIN_PID__", binId);

    var dataUrl = "{% url 'bin_data' dataset.name '__BIN_PID__' %}".replace("__BIN_PID__", binId);
    dataUrl += "?view_size=" + viewSize;
    dataUrl += "&scale_factor=" + scaleFactor;
    dataUrl += "&preload_adjacent_bins=" + true;

    // This also gets called when changing the mosaic, but do it earlier here to indicate the bin is loading as well
    $("#mosaic-loading").show();
    $("#mosaic").hide();

    $.get(dataUrl, function(data){
        currentBinId = binId;

        // Update the coordinates for the image
        coordinates = JSON.parse(data["coordinates"]);

        // Update bin name/link
        $("#bin-header").attr("href", binUrl).html(binId);

        // Update bin paging
        currentBinPage = 0;

        $("#previous-bin")
            .data("bin", data.previous_bin_id)
            .toggleClass("disabled", data.previous_bin_id === "");

        $("#next-bin")
            .data("bin", data.next_bin_id)
            .toggleClass("disabled", data.next_bin_id === "");

        // Update outline/blob links
        $("#detailed-image-blob-link").toggleClass("disabled", !data["has_blobs"]);
        $("#detailed-image-outline-link").toggleClass("disabled", !data["has_blobs"]);

        // Update map location(s)
        // TODO: Need a loading panel around the map
        if (data.lat == 0 || data.lng == 0) {
            // TODO: Need some indication there is no location (not just default map location)
            map.setView([41.5507768, -70.6593102], 11);
        } else {
            map.setView([data.lng, data.lat], 11);
        }

        if (updateHistory) {
            history.pushState(null, null, "?bin_id=" + binId);
        }

        // Update mosaic; save this for last since it will require and additional ajax request
        delayedMosaic(0);
    });
}

function loadMosaic(pageNumber) {
    var viewSize = $("#view-size option:selected").val();
    var scaleFactor = $("#scale-factor option:selected").val();

    $("#mosaic-loading").show();
    $("#mosaic").hide();

    // TODO: Fix url to use Django routing
    var binDataUrl = "/api/{{ dataset.name }}/bin/" + currentBinId +
        "?view_size=" + viewSize +
        "&scale_factor=" + scaleFactor;

    $.get(binDataUrl, function(data){

        // Update the coordinates for the image
        coordinates = JSON.parse(data["coordinates"]);

        // Update the paging
        if (data["num_pages"] != numBinPages) {
            numBinPages = data["num_pages"];

            rebuildPageIndexes();
        }

        updatePaging();
    });

    // TODO: Need to pass in scale/width/height from UI controls
    // TODO: Needs error handling if mosaic cannot be generated
    var mosaicUrl = "{% url 'mosaic_page_encoded_image' "__BIN_PID__" %}" +
        "?view_size=" + viewSize +
        "&scale_factor=" + scaleFactor +
        "&page=" + pageNumber;
    mosaicUrl = mosaicUrl.replace("__BIN_PID__", currentBinId);

    $.get(mosaicUrl, function(data){
        $("#mosaic").attr("src", "data:image/png;base64," + data);
        $("#mosaic-loading").hide();
        $("#mosaic").show();
    });
}

$("#previous-bin, #next-bin").click(function(e){
    e.preventDefault();

    changeBin($(this).data("bin"), true);
});

$("#bin-paging").on("click", ".page-previous", function(e){
    e.preventDefault();

    if (currentBinPage > 0)
        changePage(currentBinPage - 1);
});

$("#bin-paging").on("click", ".page-next", function(e){
    e.preventDefault();

    if (currentBinPage < numBinPages)
        changePage(currentBinPage + 1);
});

$("#bin-paging").on("click", ".page-index a", function(e){
    e.preventDefault();

    var pageNumber = $(this).data("page")

    changePage(pageNumber);
});

function changePage(pageNumber) {
    currentBinPage = pageNumber;

    delayedMosaic(pageNumber);
    updatePaging();
}

$("#view-size").change(function(e){
    changeBin(currentBinId, true);
});

$("#scale-factor").change(function(e){
    changeBin(currentBinId, true);
});

$("#mosaic").click(function(e){
    var x = e.pageX - $(this).offset().left;
    var y = e.pageY - $(this).offset().top;

    $.each(coordinates, function(idx, img) {
        if (currentBinPage == img.page &&
            x >= img.x && x <= img.x + img.width &&
            y >= img.y && y <= img.y + img.height) {

            // TODO: Need to handle routing from Django
            // TODO: Needs loading indicator
            // TODO: Is png the right default format
            var baseUrl = "/{{ dataset.name }}/" + currentBinId + "_" + padDigits(img.pid, 5);
            var metaUrl = "/api/image/" + currentBinId + "/" + img.pid;

            changeImage($("#detailed-image"), baseUrl + ".png", $("#detailed-image-blob"), $("#detailed-image-outline"));
            $("#detailed-image").data("image-id", img.pid);
            $("#detailed-image-link").attr("href", baseUrl + ".html");
            $("#image-modal").modal();

            $("#detailed-image-metadata tbody").empty();
            $.get(metaUrl, function(data){
                $.each(data, function(key, val) {
                    var tr = $("<tr />");
                    tr.append($("<th>").html(key));
                    tr.append($("<td>").attr("scope", "row").html(val));
                    $("#detailed-image-metadata tbody").append(tr);
                });

            });

            return false;
        }
    });
});

$("#image-modal").on("hidden.bs.modal", function() {
    $("#detailed-image").attr("src","");
    $("#detailed-image-blob").attr("src","");
    $("#detailed-image-outline").attr("src","");
});

$(".change-image").click(function(e){
    var target = $(this).data("target");

    $.each($("#images img"), function(){
        var id = $(this).attr("id");

        $(this).toggle(id == target);
    });

    // TODO: Implement Django routes instead of hardcoded ones
    if (target == "detailed-image-blob" && $("#detailed-image-blob").attr("src") === "") {
        var blobUrl = "/api/blob/" + currentBinId + "/" + $("#detailed-image").data("image-id");

        $.get(blobUrl, function(data){
            if (data["blob"] != "")
                $("#detailed-image-blob").attr("src", "data:image/png;base64," + data["blob"]);
        });
    }

    if (target == "detailed-image-outline" && $("#detailed-image-outline").attr("src") === "") {
        var outlineUrl = "/api/outline/" + currentBinId + "/" + $("#detailed-image").data("image-id");

        $.get(outlineUrl, function(data){
            if (data["outline"] != "")
                $("#detailed-image-outline").attr("src", "data:image/png;base64," + data["outline"]);
        });
    }
});

$(function() {
    // TODO: Fill in proper values and a real default starting location
    map = createMap(41.5507768, -70.6593102);

    createTimeSeries($("#ts-size .ts-plot-container"), "size");

    changeBin("{{ bin.pid }}", false);
});
</script>
{% endblock %}