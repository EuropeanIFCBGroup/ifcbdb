{% extends 'base.html' %} {% block breadcrumbs %}
<li class="breadcrumb-item"><a class="black-text" href="{% url 'dataset' dataset.name %}">{{ dataset.name }}</a></li>
{% endblock %} {% block content %}
<div class="row d-flex justify-content-start">
    <div class="pl-3">
        <h1>{{ dataset.title }}</h1>
    </div>
    {% if user.is_authenticated %}
    <div>
        <a href="#" class="btn btn-sm btn-primary ml-3">Configure</a>
    </div>
    {% endif %}
</div>
<hr class="my-3">
<div class="row py-3 px-3">
    <div class="col-sm-12">

        <ul class="nav nav-tabs" id="ts-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="ts-size-tab" data-toggle="tab" data-metric="size" href="#ts-size"
                   role="tab" aria-controls="ts-size" aria-selected="true">Data Size</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="ts-temperature-tab" data-toggle="tab" data-metric="temperature" href="#ts-temperature"
                   role="tab" aria-controls="ts-temperature" aria-selected="false">Temperature</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="ts-humidity-tab" data-toggle="tab" data-metric="humidity" href="#ts-humidity"
                   role="tab" aria-controls="ts-humidity" aria-selected="false">Humidity</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="ts-ml-analyzed-tab" data-toggle="tab" data-metric="ml-analyzed" href="#ts-ml-analyzed"
                   role="tab" aria-controls="ts-ml-analyzed" aria-selected="false">Volume Imaged</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="ts-concentration-tab" data-toggle="tab" data-metric="concentration" href="#ts-concentration"
                   role="tab" aria-controls="ts-concentration" aria-selected="false">Concentration</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="ts-triggers-tab" data-toggle="tab" data-metric="n-triggers" href="#ts-triggers"
                   role="tab" aria-controls="ts-triggers" aria-selected="false">Trigger Count</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="ts-images-tab" data-toggle="tab" data-metric="n-images" href="#ts-images"
                   role="tab" aria-controls="ts-images" aria-selected="false">Image Count</a>
            </li>
        </ul>

        <div class="tab-content" id="ts-data">
            <div class="tab-pane fade show active" id="ts-size" role="tabpanel" aria-labelledby="ts-size-tab">
                <div class="ts-plot-container" style="width:100%;height:250px;"></div>
            </div>
            <div class="tab-pane fade" id="ts-temperature" role="tabpanel" aria-labelledby="ts-temperature-tab">
                <div class="ts-plot-container" style="width:100%;height:250px;"></div>
            </div>
            <div class="tab-pane fade" id="ts-humidity" role="tabpanel" aria-labelledby="ts-humidity-tab">
                <div class="ts-plot-container" style="width:100%;height:250px;"></div>
            </div>
            <div class="tab-pane fade" id="ts-ml-analyzed" role="tabpanel" aria-labelledby="ts-ml-analyzed-tab">
                <div class="ts-plot-container" style="width:100%;height:250px;"></div>
            </div>
            <div class="tab-pane fade" id="ts-concentration" role="tabpanel" aria-labelledby="ts-concentration-tab">
                <div class="ts-plot-container" style="width:100%;height:250px;"></div>
            </div>
            <div class="tab-pane fade" id="ts-triggers" role="tabpanel" aria-labelledby="ts-triggers-tab">
                <div class="ts-plot-container" style="width:100%;height:250px;"></div>
            </div>
            <div class="tab-pane fade" id="ts-images" role="tabpanel" aria-labelledby="ts-images-tab">
                <div class="ts-plot-container" style="width:100%;height:250px;"></div>
            </div>
        </div>
    </div>
</div>
<div class="row py-2 card-deck">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="row col justify-content-between">

                    <form class="form-inline my-2 my-lg-0">
                        <a href="#" id="previous-bin" data-bin="{{ previous_bin.pid }}"><span class="waves-effect"><i class="fas fa-arrow-circle-left fa-2x"></i></span></a>
                    </form>
                    <span class="h4-responsive">
                        <strong>Bin:</strong>
                        <small class="text-muted"><a id="bin-header" href="{% url 'bin' dataset.name bin.pid %}">{{ bin.pid }}</a></small>
                    </span>
                    <form class="form-inline my-2 my-lg-0">
                        <a href="#" id="next-bin" data-bin="{{ next_bin.pid }}"><span class="waves-effect"><i class="fas fa-arrow-circle-right fa-2x"></i></span></a>
                    </form>

                </div>
            </div>

            <div class="card-body text-center">
                <img class="img-fluid" id="mosaic" src="data:image/png;base64,{{image}}" data-toggle="modal" data-target="#exampleModalCenter" />
                <br clear="all" />
            </div>
            <div class="card-footer text-center">
                <nav aria-label="Page navigation example" class="text-center">
                    <ul class="pagination pg-blue justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" tabindex="-1">Previous</a>
                        </li>
                        <li class="page-item"><a class="page-link">1</a></li>
                        <li class="page-item active">
                            <a class="page-link">2 <span class="sr-only">(current)</span></a>
                        </li>
                        <li class="page-item"><a class="page-link">3</a></li>
                        <li class="page-item">
                            <a class="page-link">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h2 class="h4-responsive">Location</h2>
            </div>
            <div class="card-body">
                <div id="mapid" style="height:600px;"></div>
            </div>
            <div class="card-footer">
                <p>41 north, 82 east (41.31, -70.39), depth 5m</p>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">

    <!-- Add .modal-dialog-centered to .modal-dialog to vertically center the modal -->
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">


        <div class="modal-content">
            <div class="modal-body">
                <img class="img-fluid" id="bin-mosaic" src="data:image/png;base64,{{image}}" />
            </div>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
var map;
var plot;

function getClosestBin(targetDate) {
    var url = "{% url 'closest_bin' dataset.name %}";

    $.post(url, {"target_date": targetDate}, function(resp){
        if (resp.bin_id != "")
            changeBin(resp.bin_id);
    });
}

function createTimeSeries(container, metric) {
    var dataUrl = "/api/{{ dataset.name }}/time-series/" + metric;

    plot = Plotly.d3.json(dataUrl, function(err, response) {
        var data = [{
            type: "bar",
            x: response["x"],
            y: response["y"],
            line: {
                color: '#17BECF'
            },
        }];


        var layout = {
            bargap: .05,
            yaxis: {
                title: {
                    text: response["y-axis"]
                }
            },
        };

        var config = {
            responsive: true,
            displaylogo: false
        };

        Plotly.newPlot(container[0], data, layout, config);

        // Add event to locate nearest bin to user's click
        container[0].on("plotly_click", function(d){
            var x = getClosestBin(d.points[0].x);

        });
    });

}

$("#bin-details").click(function(e) {
    var url = "{% url 'bin' dataset.name '__BIN_PID__' %}";
    var pid = $("#bin-switcher").val();

    location.href = url.replace("__BIN_PID__", pid);
});

$("#ts-tabs .nav-link").click(function() {
    var metric = $(this).data("metric");
    var container = $("#" + $(this).attr("aria-controls") + " .ts-plot-container")

    // TODO: The timeout is temporary; the plot needs to be drawn after the tab has switched, which has a delay
    //   due to the transition effect
    setTimeout(function(){
        createTimeSeries(container, metric);
    }, 300);
});

function changeBin(binId) {
    var baseDataUrl = "{% url 'bin_data' dataset.name '__BIN_PID__' %}";
    var baseBinUrl = "{% url 'bin' dataset.name '__BIN_PID__' %}";
    var dataUrl = baseDataUrl.replace("__BIN_PID__", binId); // "/api/{{ dataset.name }}/bin/" + binPid;
    var binUrl = baseBinUrl.replace("__BIN_PID__", binId);

    $.get(dataUrl, function(data){
        console.log(data);

        // Update mosaic
        // TODO: Needs error handling if mosaic cannot be generated
        // TODO: Needs to pass proper scaling, etc settings
        $("#mosaic").attr("src", "data:image/png;base64," + data.mosaic);

        // TODO: Needs a loading panel

        // Update bin name/link
        $("#bin-header")
            .attr("href", binUrl)
            .html(binId);

        // Update bin paging
        $("#previous-bin").data("bin", data.previous_bin_id);
        $("#next-bin").data("bin", data.next_bin_id);

        // TODO: Update image paging

        // Update map location(s)
        // TODO: Need a loading panel around the map
        if (data.lat == 0 || data.lng == 0) {
            // TODO: Need some indication there is no location (not just default map location)
            map.setView([41.5507768, -70.6593102], 11);
        } else {
            map.setView([data.lng, data.lat], 11);
        }
    });
}

$("#previous-bin, #next-bin").click(function(e){
    e.preventDefault();

    var binId = $(this).data("bin");
    if (binId === "")
        return;

    changeBin(binId);
});

$(function() {
    // TODO: Fill in proper values and a real default starting location
    map = createMap(41.5507768, -70.6593102);

    createTimeSeries($("#ts-size .ts-plot-container"), "size");

});
</script>
{% endblock %}